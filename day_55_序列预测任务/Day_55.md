# Day 55: åºåˆ—é¢„æµ‹ä»»åŠ¡è¯¦è§£

åœ¨å­¦ä¹ RNNåŠå…¶å˜ä½“ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ç†è§£åºåˆ—ä»»åŠ¡çš„æœ¬è´¨ã€‚æœ¬èŠ‚å°†ç³»ç»Ÿä»‹ç»ï¼š
- ä»€ä¹ˆæ˜¯åºåˆ—é¢„æµ‹
- å¦‚ä½•æ„å»ºåºåˆ—æ•°æ®çš„x-yå¯¹
- å•æ­¥é¢„æµ‹ä¸å¤šæ­¥é¢„æµ‹çš„åŒºåˆ«
- æ—¶åºä»»åŠ¡çš„å®æˆ˜æ¼”ç»ƒ

---
## ä¸€ã€åºåˆ—é¢„æµ‹ä»»åŠ¡ä»‹ç»

### 1.1 ä»€ä¹ˆæ˜¯åºåˆ—é¢„æµ‹ï¼Ÿ

**ä¼ ç»Ÿç»“æ„åŒ–æ•°æ® vs åºåˆ—æ•°æ®**

| ç‰¹æ€§ | ç»“æ„åŒ–æ•°æ® | åºåˆ—æ•°æ® |
|------|-----------|----------|
| æ ·æœ¬å…³ç³» | ç‹¬ç«‹æ— å…³ | å­˜åœ¨å…ˆåé¡ºåº |
| é¡ºåºå½±å“ | è°ƒæ¢é¡ºåºä¸å½±å“è®­ç»ƒ | é¡ºåºè‡³å…³é‡è¦ |
| å…¸å‹ä»»åŠ¡ | åˆ†ç±»ã€å›å½’ | é¢„æµ‹ä¸‹ä¸€æ­¥çš„å€¼ |

**å¸¸è§åºåˆ—é¢„æµ‹åœºæ™¯ï¼š**
- ğŸ“ˆ è‚¡ç¥¨ä»·æ ¼é¢„æµ‹ï¼šç”¨è¿‡å»30å¤©ä»·æ ¼é¢„æµ‹ç¬¬31å¤©
- ğŸš² å•è½¦éœ€æ±‚é¢„æµ‹ï¼šç”¨å‰60å¤©æ•°æ®é¢„æµ‹å20å¤©é”€é‡
- ğŸ“ æ–‡æœ¬ç”Ÿæˆï¼šé¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯

### 1.2 åºåˆ—é¢„æµ‹çš„x-yå¯¹æ„å»º

**æ ¸å¿ƒæ–¹æ³•ï¼šæ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰**

å°†åŸå§‹åºåˆ—è½¬åŒ–ä¸ºç›‘ç£å­¦ä¹ æ‰€éœ€çš„x-yæ ‡ç­¾å¯¹ã€‚

**ç¤ºä¾‹ï¼š**
- åŸå§‹æ•°æ®ï¼š`data = [10, 20, 30, 40, 50, 60, 70, 80, 90]`
- åºåˆ—é•¿åº¦ï¼š`seq_length = 3`

```
æ»‘åŠ¨çª—å£è¿‡ç¨‹:
[10, 20, 30] â†’ 40
   [20, 30, 40] â†’ 50
      [30, 40, 50] â†’ 60
         [40, 50, 60] â†’ 70
            [50, 60, 70] â†’ 80
               [60, 70, 80] â†’ 90
```

**ç”Ÿæˆçš„æ•°æ®å¯¹ï¼š**
```python
X = [[10, 20, 30], [20, 30, 40], [30, 40, 50], 
     [40, 50, 60], [50, 60, 70], [60, 70, 80]]
y = [40, 50, 60, 70, 80, 90]
```

**æ³¨æ„ï¼š** æ ·æœ¬æ•° = `len(data) - seq_length` = 9 - 3 = 6

### 1.3 åºåˆ—é¢„æµ‹çš„æ ‡å‡†è¾“å…¥æ ¼å¼

æ ‡å‡†åºåˆ—æ•°æ®å¼ é‡å…·æœ‰ä¸‰ä¸ªç»´åº¦ï¼š**[æ‰¹é‡å¤§å°, åºåˆ—é•¿åº¦, ç‰¹å¾ç»´åº¦]**

| ç»´åº¦ | å«ä¹‰ | è¯´æ˜ |
|------|------|------|
| Batch Size | æ‰¹é‡å¤§å° | ä¸€æ¬¡å–‚ç»™æ¨¡å‹çš„æ ·æœ¬æ•°é‡ |
| Sequence Length | åºåˆ—é•¿åº¦ | æ¯ä¸ªæ ·æœ¬åŒ…å«çš„æ—¶é—´æ­¥æ•° |
| Feature Dimension | ç‰¹å¾ç»´åº¦ | æ¯ä¸ªæ—¶é—´æ­¥çš„ç‰¹å¾æ•°é‡ |

---
## äºŒã€åŸºç¡€æ¦‚å¿µ

### 2.1 ç¯å¢ƒå‡†å¤‡


```python
# ==================== å¯¼å…¥å¿…è¦çš„åº“ ====================
import numpy as np
import random
import os
import matplotlib.pyplot as plt
import torch
import torch.nn as nn
import torch.optim as optim
from torch.utils.data import DataLoader, TensorDataset
from sklearn.preprocessing import MinMaxScaler
from sklearn.metrics import mean_squared_error
from sklearn.ensemble import RandomForestRegressor

# ==================== ä¸­æ–‡æ˜¾ç¤ºè®¾ç½® ====================
plt.rcParams['font.sans-serif'] = ['SimHei']  # æ˜¾ç¤ºä¸­æ–‡
plt.rcParams['axes.unicode_minus'] = False     # æ˜¾ç¤ºè´Ÿå·

# ==================== å¿½ç•¥è­¦å‘Š ====================
import warnings
warnings.filterwarnings("ignore")
```


```python
# ==================== è®¾ç½®éšæœºç§å­å‡½æ•° ====================
def set_seed(seed=42, deterministic=True):
    """
    è®¾ç½®å…¨å±€éšæœºç§å­ï¼Œç¡®ä¿å®éªŒå¯é‡å¤æ€§
    
    å‚æ•°:
        seed: éšæœºç§å­å€¼ï¼Œé»˜è®¤ä¸º42
        deterministic: æ˜¯å¦å¯ç”¨ç¡®å®šæ€§æ¨¡å¼ï¼Œé»˜è®¤ä¸ºTrue
    """
    # Pythonéšæœºç§å­
    random.seed(seed)
    os.environ['PYTHONHASHSEED'] = str(seed)  # ç¡®ä¿å“ˆå¸Œå‡½æ•°éšæœºæ€§ä¸€è‡´
    
    # NumPyéšæœºç§å­
    np.random.seed(seed)
    
    # PyTorchéšæœºç§å­
    torch.manual_seed(seed)           # CPU
    torch.cuda.manual_seed(seed)      # å•GPU
    torch.cuda.manual_seed_all(seed)  # å¤šGPU
    
    # cuDNNç¡®å®šæ€§é…ç½®
    if deterministic:
        torch.backends.cudnn.deterministic = True
        torch.backends.cudnn.benchmark = False

# è®¾ç½®éšæœºç§å­
set_seed(42)
print("éšæœºç§å­è®¾ç½®å®Œæˆï¼")
```

    éšæœºç§å­è®¾ç½®å®Œæˆï¼


### 2.2 æ•°æ®ç”Ÿæˆ


```python
# ==================== ç”Ÿæˆåˆæˆæ—¶é—´åºåˆ—æ•°æ® ====================
# åœ¨0åˆ°100ä¹‹é—´ç”Ÿæˆ1000ä¸ªå‡åŒ€åˆ†å¸ƒçš„ç‚¹
x = np.linspace(0, 100, 1000)

# æ„é€ æ—¶é—´åºåˆ—ï¼šæ­£å¼¦æ³¢ + çº¿æ€§è¶‹åŠ¿ + éšæœºå™ªå£°
y = np.sin(x) + 0.1 * x + np.random.normal(0, 0.5, 1000)

# ==================== å¯è§†åŒ–åŸå§‹æ•°æ® ====================
plt.figure(figsize=(12, 6))
plt.plot(y, color='steelblue', linewidth=0.8)
plt.title('åˆæˆæ—¶é—´åºåˆ—æ•°æ®ï¼ˆæ­£å¼¦æ³¢ + è¶‹åŠ¿ + å™ªå£°ï¼‰', fontsize=14)
plt.xlabel('æ—¶é—´æ­¥', fontsize=12)
plt.ylabel('å€¼', fontsize=12)
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()

print(f"æ•°æ®æ€»é•¿åº¦: {len(y)}")
```


    
![png](Day_55_files/Day_55_10_0.png)
    


    æ•°æ®æ€»é•¿åº¦: 1000


### 2.3 å•æ­¥é¢„æµ‹ä¸å¤šæ­¥é¢„æµ‹

**é‡è¦æ¦‚å¿µï¼š** åºåˆ—é¢„æµ‹ä¸­ï¼Œè®­ç»ƒé›†å’Œæµ‹è¯•é›†å¿…é¡»æŒ‰æ—¶é—´é¡ºåºåˆ’åˆ†ï¼

#### å•æ­¥é¢„æµ‹ï¼ˆSingle-Step Predictionï¼‰
- ä¸€æ¬¡åªé¢„æµ‹ä¸‹ä¸€ä¸ªæ—¶åˆ»
- è®­ç»ƒæ ·æœ¬ï¼š`[x1,x2,x3,x4,x5] â†’ x6`

#### å¤šæ­¥é¢„æµ‹ï¼ˆMulti-Step Predictionï¼‰
ä¸¤ç§å®ç°æ–¹å¼ï¼š

| æ–¹å¼ | åŸç† | ä¼˜ç¼ºç‚¹ |
|------|------|--------|
| é€’å½’å¼ | ç”¨é¢„æµ‹å€¼ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥ | è¯¯å·®ä¼šç´¯ç§¯ |
| ç›´æ¥å¼ | æ¨¡å‹ç›´æ¥è¾“å‡ºå¤šä¸ªæ—¶åˆ» | æ— è¯¯å·®ç´¯ç§¯ï¼Œä½†æ¨¡å‹æ›´å¤æ‚ |

**MIMOä»»åŠ¡ï¼š** å¤šè¾“å…¥å¤šè¾“å‡ºï¼ˆMultiple-Input Multiple-Outputï¼‰

### 2.4 å¤šè¾“å…¥å¤šè¾“å‡ºä»»åŠ¡è¯´æ˜

**åº”ç”¨åœºæ™¯ç¤ºä¾‹ï¼š**
- è¾“å…¥ï¼šä½“æ£€æŒ‡æ ‡ï¼ˆè¡€å‹ã€è¡€ç³–ã€èƒ†å›ºé†‡ï¼‰ã€ç—…å²ã€å¹´é¾„
- è¾“å‡ºï¼šç³–å°¿ç—…é£é™©ã€å† å¿ƒç—…é£é™©ã€è‚¥èƒ–ç­‰çº§

**è§£å†³æ–¹æ¡ˆï¼š**
1. **ç‹¬ç«‹å»ºæ¨¡**ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªå•è¾“å‡ºä»»åŠ¡ï¼ˆå¯èƒ½ä¸¢å¤±æ ‡ç­¾é—´å…³ç³»ï¼‰
2. **è”åˆå»ºæ¨¡**ï¼šç¥ç»ç½‘ç»œå¤šè¾“å‡ºæ¨¡å‹ï¼ˆå¦‚BERTçš„MLM+NSPè”åˆè®­ç»ƒï¼‰

---
## ä¸‰ã€æ—¶åºä»»åŠ¡å®æˆ˜

### 3.1 æ•°æ®é¢„å¤„ç†ä¸åˆ’åˆ†

**æ­£ç¡®æµç¨‹ï¼š** å…ˆæ»‘åŠ¨çª—å£ â†’ å†åˆ’åˆ†è®­ç»ƒ/æµ‹è¯•é›†

âš ï¸ **å¸¸è§é”™è¯¯ï¼š** å…ˆåˆ’åˆ†å†æ»‘åŠ¨çª—å£ä¼šå¯¼è‡´éƒ¨åˆ†æ ‡ç­¾æœªè¢«ä½¿ç”¨


```python
# ==================== å‚æ•°è®¾ç½® ====================
seq_length = 30      # åºåˆ—é•¿åº¦ï¼šç”¨å‰30ä¸ªæ—¶é—´æ­¥é¢„æµ‹ä¸‹ä¸€ä¸ª
train_ratio = 0.8    # è®­ç»ƒé›†æ¯”ä¾‹
train_size = int(len(y) * train_ratio)

# ==================== æ•°æ®æ ‡å‡†åŒ– ====================
# å…³é”®ï¼šåªåœ¨è®­ç»ƒæ•°æ®ä¸Šfitï¼Œç„¶åtransformæ•´ä¸ªæ•°æ®é›†
train_data_raw = y[:train_size]

scaler = MinMaxScaler(feature_range=(0, 1))
scaler.fit(train_data_raw.reshape(-1, 1))  # åªç”¨è®­ç»ƒæ•°æ®æ‹Ÿåˆ
scaled_y = scaler.transform(y.reshape(-1, 1)).flatten()  # è½¬æ¢æ•´ä¸ªæ•°æ®é›†

print(f"åŸå§‹æ•°æ®èŒƒå›´: [{y.min():.2f}, {y.max():.2f}]")
print(f"æ ‡å‡†åŒ–åèŒƒå›´: [{scaled_y.min():.2f}, {scaled_y.max():.2f}]")
```

    åŸå§‹æ•°æ®èŒƒå›´: [-1.37, 11.21]
    æ ‡å‡†åŒ–åèŒƒå›´: [0.00, 1.14]



```python
# ==================== åˆ›å»ºåºåˆ—æ•°æ®é›†å‡½æ•° ====================
def create_sequences(data, seq_length):
    """
    å°†æ—¶é—´åºåˆ—æ•°æ®è½¬æ¢ä¸ºç›‘ç£å­¦ä¹ æ ¼å¼
    
    å‚æ•°:
        data: åŸå§‹æ—¶é—´åºåˆ—æ•°æ®
        seq_length: è¾“å…¥åºåˆ—çš„é•¿åº¦
    
    è¿”å›:
        X: è¾“å…¥åºåˆ—é›† (æ ·æœ¬æ•°, åºåˆ—é•¿åº¦)
        y: ç›®æ ‡å€¼é›† (æ ·æœ¬æ•°,)
    """
    X, y = [], []
    for i in range(len(data) - seq_length):
        X.append(data[i:i+seq_length])    # è¾“å…¥ï¼šè¿ç»­seq_lengthä¸ªå€¼
        y.append(data[i+seq_length])       # è¾“å‡ºï¼šä¸‹ä¸€ä¸ªå€¼
    return np.array(X), np.array(y)

# ==================== åœ¨æ•´ä¸ªæ•°æ®é›†ä¸Šåˆ›å»ºåºåˆ— ====================
all_X, all_y = create_sequences(scaled_y, seq_length)
print(f"æ»‘åŠ¨çª—å£åæ€»æ ·æœ¬æ•°: {len(all_X)}")
```

    æ»‘åŠ¨çª—å£åæ€»æ ·æœ¬æ•°: 970



```python
# ==================== åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›† ====================
# è®¡ç®—åˆ†å‰²ç‚¹ï¼šæœ€åä¸€ä¸ªè®­ç»ƒæ ·æœ¬çš„æ ‡ç­¾ç´¢å¼•ä¸º train_size-1
split_idx = train_size - seq_length

X_train = all_X[:split_idx]
y_train = all_y[:split_idx]
X_test = all_X[split_idx:]
y_test = all_y[split_idx:]

# ==================== éªŒè¯æ•°æ®åˆ’åˆ† ====================
print("="*50)
print("æ•°æ®åˆ’åˆ†ç»“æœï¼š")
print("="*50)
print(f"åŸå§‹æ•°æ®æ€»é•¿åº¦: {len(y)}")
print(f"åºåˆ—é•¿åº¦ (seq_length): {seq_length}")
print(f"è®­ç»ƒé›†åˆ’åˆ†ç‚¹ (split_idx): {split_idx}")
print("-"*50)
print(f"è®­ç»ƒé›†ç‰¹å¾ X_train å½¢çŠ¶: {X_train.shape}")
print(f"è®­ç»ƒé›†æ ‡ç­¾ y_train å½¢çŠ¶: {y_train.shape}")
print(f"æµ‹è¯•é›†ç‰¹å¾ X_test å½¢çŠ¶: {X_test.shape}")
print(f"æµ‹è¯•é›†æ ‡ç­¾ y_test å½¢çŠ¶: {y_test.shape}")
print("="*50)
```

    ==================================================
    æ•°æ®åˆ’åˆ†ç»“æœï¼š
    ==================================================
    åŸå§‹æ•°æ®æ€»é•¿åº¦: 1000
    åºåˆ—é•¿åº¦ (seq_length): 30
    è®­ç»ƒé›†åˆ’åˆ†ç‚¹ (split_idx): 770
    --------------------------------------------------
    è®­ç»ƒé›†ç‰¹å¾ X_train å½¢çŠ¶: (770, 30)
    è®­ç»ƒé›†æ ‡ç­¾ y_train å½¢çŠ¶: (770,)
    æµ‹è¯•é›†ç‰¹å¾ X_test å½¢çŠ¶: (200, 30)
    æµ‹è¯•é›†æ ‡ç­¾ y_test å½¢çŠ¶: (200,)
    ==================================================


### 3.2 æ¨¡å‹æ­å»ºä¸è®­ç»ƒ

**æ€è€ƒï¼š** åºåˆ—æ•°æ®çš„x-yå¯¹å¯ä»¥ç”¨ä¼ ç»Ÿæœºå™¨å­¦ä¹ æ¨¡å‹å—ï¼Ÿ

**ç­”æ¡ˆï¼š** å¯ä»¥ï¼å› ä¸ºï¼š
1. è®­ç»ƒé›†æŒ‰æ—¶é—´é¡ºåºåˆ’åˆ†ï¼Œçœ‹ä¸åˆ°æœªæ¥ä¿¡æ¯
2. æ·±åº¦å­¦ä¹ ä¸­ï¼ŒåŒä¸€æ‰¹æ¬¡å†…å„æ ·æœ¬æŸå¤±ç‹¬ç«‹è®¡ç®—
3. æ‰“ä¹±è®­ç»ƒé¡ºåºæœ‰åŠ©äºé¿å…å±€éƒ¨æœ€ä¼˜


```python
# ==================== ä½¿ç”¨éšæœºæ£®æ—è¿›è¡Œåºåˆ—é¢„æµ‹ ====================
print("å¼€å§‹è®­ç»ƒéšæœºæ£®æ—æ¨¡å‹...")

# åˆ›å»ºå¹¶è®­ç»ƒæ¨¡å‹
rf_model = RandomForestRegressor(
    n_estimators=100,    # æ ‘çš„æ•°é‡
    max_depth=10,        # æœ€å¤§æ·±åº¦
    random_state=42,     # éšæœºç§å­
    n_jobs=-1            # ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
)
rf_model.fit(X_train, y_train)
print("æ¨¡å‹è®­ç»ƒå®Œæˆï¼")

# ==================== æ¨¡å‹é¢„æµ‹ ====================
y_train_pred = rf_model.predict(X_train)
y_test_pred = rf_model.predict(X_test)

# ==================== è¯„ä¼°æ¨¡å‹ ====================
# åæ ‡å‡†åŒ–ä»¥è®¡ç®—çœŸå®å°ºåº¦çš„RMSE
y_train_true = scaler.inverse_transform(y_train.reshape(-1, 1)).flatten()
y_train_pred_inv = scaler.inverse_transform(y_train_pred.reshape(-1, 1)).flatten()
y_test_true = scaler.inverse_transform(y_test.reshape(-1, 1)).flatten()
y_test_pred_inv = scaler.inverse_transform(y_test_pred.reshape(-1, 1)).flatten()

train_rmse = np.sqrt(mean_squared_error(y_train_true, y_train_pred_inv))
test_rmse = np.sqrt(mean_squared_error(y_test_true, y_test_pred_inv))

print(f"\nè®­ç»ƒé›† RMSE: {train_rmse:.4f}")
print(f"æµ‹è¯•é›† RMSE: {test_rmse:.4f}")
```

    å¼€å§‹è®­ç»ƒéšæœºæ£®æ—æ¨¡å‹...
    æ¨¡å‹è®­ç»ƒå®Œæˆï¼
    
    è®­ç»ƒé›† RMSE: 0.2398
    æµ‹è¯•é›† RMSE: 1.1185



```python
# ==================== å¯è§†åŒ–é¢„æµ‹ç»“æœ ====================
plt.figure(figsize=(14, 6))

# ç»˜åˆ¶çœŸå®å€¼
plt.plot(range(len(y_train_true)), y_train_true, 
         label='è®­ç»ƒé›†çœŸå®å€¼', color='steelblue', alpha=0.7)
plt.plot(range(len(y_train_true), len(y_train_true) + len(y_test_true)), y_test_true, 
         label='æµ‹è¯•é›†çœŸå®å€¼', color='darkorange', alpha=0.7)

# ç»˜åˆ¶é¢„æµ‹å€¼
plt.plot(range(len(y_train_pred_inv)), y_train_pred_inv, 
         label='è®­ç»ƒé›†é¢„æµ‹å€¼', color='lightblue', linestyle='--', alpha=0.8)
plt.plot(range(len(y_train_pred_inv), len(y_train_pred_inv) + len(y_test_pred_inv)), y_test_pred_inv, 
         label='æµ‹è¯•é›†é¢„æµ‹å€¼', color='red', linestyle='--', alpha=0.8)

# æ·»åŠ åˆ†å‰²çº¿
plt.axvline(x=len(y_train_true), color='gray', linestyle=':', linewidth=2, label='è®­ç»ƒ/æµ‹è¯•åˆ†å‰²çº¿')

plt.title('éšæœºæ£®æ—åºåˆ—é¢„æµ‹ç»“æœ', fontsize=14)
plt.xlabel('æ—¶é—´æ­¥', fontsize=12)
plt.ylabel('å€¼', fontsize=12)
plt.legend(loc='upper left', fontsize=10)
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```


    
![png](Day_55_files/Day_55_20_0.png)
    


---
## å››ã€æ€»ç»“


1. **åºåˆ—é¢„æµ‹æœ¬è´¨**ï¼šåˆ©ç”¨å†å²æ•°æ®çš„æ—¶åºå…³ç³»é¢„æµ‹æœªæ¥å€¼

2. **æ•°æ®å¤„ç†æµç¨‹**ï¼š
   - æ»‘åŠ¨çª—å£æ„å»ºx-yå¯¹
   - å…ˆæ»‘åŠ¨çª—å£ï¼Œå†åˆ’åˆ†æ•°æ®é›†
   - æ ‡å‡†åŒ–æ—¶åªç”¨è®­ç»ƒæ•°æ®fit

3. **é¢„æµ‹æ–¹å¼**ï¼š
   - å•æ­¥é¢„æµ‹ï¼šä¸€æ¬¡é¢„æµ‹ä¸€ä¸ªæ—¶åˆ»
   - å¤šæ­¥é¢„æµ‹ï¼šé€’å½’å¼æˆ–ç›´æ¥å¼

4. **æ¨¡å‹é€‰æ‹©**ï¼š
   - ä¼ ç»ŸMLæ¨¡å‹ï¼ˆå¦‚éšæœºæ£®æ—ï¼‰å¯ç”¨äºåºåˆ—é¢„æµ‹
   - ç¥ç»ç½‘ç»œæ›´é€‚åˆå¤æ‚çš„å¤šè¾“å…¥å¤šè¾“å‡ºä»»åŠ¡


